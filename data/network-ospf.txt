OSPF

Open Shortest Path First (OSPF) — это открытый протокол маршрутизации, относящийся к классу протоколов внутреннего шлюза (IGP), использующий алгоритм состояния каналов (link-state). Разработан как альтернатива протоколу RIP и стандартизирован в RFC 2328 (OSPFv2) для IPv4 и RFC 5340 (OSPFv3) для IPv6.

OSPF основан на технологии поиска кратчайшего пути SPF (Shortest Path First), которая применяет алгоритм Дейкстры для расчёта оптимальных маршрутов. В отличие от дистанционно-векторных протоколов, OSPF обладает полной картиной сети, что позволяет ему быстрее сходиться и эффективнее использовать полосу пропускания.




Ключевые характеристики OSPF:
1. Быстрая сходимость — минимальное время реакции на изменения в сетевой топологии.
2. Иерархическая структура — разделение сети на области (areas) для увеличения масштабируемости, снижения нагрузки на процессоры маршрутизаторов и служебный трафик в сети.
3. Экономное использование полосы пропускания — отправка только изменений состояния связей.
4. Поддержка VLSM и CIDR — эффективное использование IP-адресного пространства.
5. Аутентификация — защита обмена маршрутной информации.




Установка соседства (adjacency) в OSPF — ключевой этап, без которого обмен маршрутной информацией невозможен.
Соседство — соединение между двумя маршрутизаторами по протоколу OSPF, позволяющее им напрямую обмениваться LSA (Link‑State Advertisements) и синхронизировать LSDB (Link‑State Database).

Условия установления соседства:
1. Маска подсети — должна быть идентичной.
2. Идентификаторы маршрутизаторов (Router-id) должны отличаться.
3. Идентификатор зоны (Area ID) — маршрутизаторы должны находиться в одной зоне.
4. Тип зоны — например, оба не могут быть в разных типах (Stub и NSSA).
5. Параметры аутентификации — метод и ключ (если аутентификация включена).
6. Интервалы таймеров:
    - Hello Interval — как часто отправляются Hello‑пакеты (по умолчанию: 10 с для broadcast, 30 с для NBMA).
    - Router Dead Interval — время ожидания ответа перед объявлением соседа «мёртвым» (по умолчанию: 4 × Hello Interval).
7. MTU — максимальный размер пакета (некоторые реализации проверяют совпадение).
8. Флаг E (External) в Hello‑пакетах — должен совпадать (определяет, могут ли маршрутизаторы принимать внешние маршруты).




Таймеры:
1. hello-interval — периодичность отправки Hello-пакетов (по умолчанию 10 секунд).
2. dead-interval — время, после которого сосед считается недоступным (по умолчанию 40 секунд).
3. timers throttle spf — параметры задержки для алгоритма SPF (начальная задержка, максимальная задержка, время удержания).




Роли маршрутизаторов в OSPF:
1. Internal Router — все интерфейсы в одной области.
2. Area Border Router (ABR) — соединяет две или более областей.
3. Backbone Router — имеет хотя бы один интерфейс в Area 0.
4. Autonomous System Boundary Router (ASBR) — соединяет OSPF с другими протоколами маршрутизации.





Этапы установления соседства:

1. Down
Начальное состояние. Маршрутизатор ещё не обнаружил соседа. Отправляет Hello‑пакеты в сегмент.

2. Init
Маршрутизатор получил Hello‑пакет от соседа, но в этом пакете своего Router ID ещё нет. Значит, сосед пока не «видит» его в ответ.

3. 2‑Way
В полученном Hello‑пакете от соседа обнаружен собственный Router ID.
Для сетей типа broadcast и NBMA на этом этапе выбираются DR (Designated Router) и BDR (Backup Designated Router).
В point‑to‑point сетях переход к следующему этапу происходит сразу.

4. ExStart
Определение master/slave для обмена DBD (Database Description) пакетами. Маршрутизатор с большим Router ID становится master и инициирует обмен.

5. Exchange
Обмен DBD‑пакетами — краткое описание LSDB каждого маршрутизатора. Каждый узнает, какие LSA есть у соседа.

6. Loading
Запрос недостающих LSA через LSR (Link State Request).
Получение полных LSA через LSU (Link State Update).
Подтверждение через LSAck (Link State Acknowledgment).

7.Full
LSDB синхронизированы.
Соседство установлено, маршрутизаторы готовы обмениваться маршрутной информацией.




Роль DR и BDR:
В сетях с множественным доступом (например, Ethernet) выбираются:
 - DR — центральный узел для обмена LSA. Все маршрутизаторы устанавливают соседство только с DR и BDR.
 - BDR — резервный DR. Перенимает роль, если DR выходит из строя.

Как выбираются DR/BDR:
 - По приоритету интерфейса (0–255; по умолчанию 1). Приоритет 0 исключает маршрутизатор из выборов.
 - Если приоритеты равны — по наибольшему Router ID.




Типы пакетов OSPF:
 - Hello — обнаружение соседей, поддержание соседства.
 - DBD (Database Description) — краткое описание LSDB.
 - LSR (Link State Request) — запрос конкретных LSA.
 - LSU (Link State Update) — передача полных LSA.
 - LSAck — подтверждение получения LSU.




Типы LSA (Link State Advertisement):

1. LSA Type 1: Router LSA
Источник: все маршрутизаторы в зоне.
Область распространения: только внутри своей зоны (не выходит за её пределы).
Содержание: описывает собственные интерфейсы маршрутизатора, их состояние и стоимость связей, а также список соседей в той же зоне.
Ключевая особенность: основа для построения топологии внутри зоны.

2. LSA Type 2: Network LSA
Источник: Designated Router (DR) в сетях с множественным доступом (например, Ethernet).
Область распространения: внутри зоны.
Содержание: список всех маршрутизаторов, подключённых к сегменту, где работает DR.
Ключевая особенность: позволяет построить полную карту топологии сегмента.

3. LSA Type 3: Summary LSA
Источник: Area Border Router (ABR).
Область распространения: между зонами (передаётся в другие зоны).
Содержание: суммарная информация о сетях в соседней зоне (маршруты внутри зоны, агрегированные ABR).
Ключевая особенность: обеспечивает межзоновую маршрутизацию.

5. LSA Type 5: AS External LSA
Источник: ASBR.
Область распространения: по всей автономной системе (AS).
Содержание: описывает внешние маршруты, импортированные в OSPF (например, из BGP).
Ключевая особенность: единственный тип LSA, несущий информацию о внешних сетях.
Каждый ASBR генерирует по одной LSA на каждый префикс.
 - Тип 1: E1 - суммарная метрика инстраллированного префикса и стоимость пути следования в OSPF домене (исходящих интерфейсов).
 - Тип 2: E2 - метрика которая не изменяется по пути следования в OSPF домене.

4. LSA Type 4: ASBR Summary LSA
Источник: ABR.
Область распространения: в другие зоны (кроме той, где находится ASBR).
Содержание: информирует о наличии Autonomous System Border Router (ASBR) в другой зоне (указывает его Router ID).
Ключевая особенность: есть проблема, марщрутизаторы могут не знать, как добраться до ASBR находящегося в другой зоне. Необходим для корректной маршрутизации к внешним сетям через ASBR.
ABR распространяет инфрмацию о наличии ASBR в сети, по одной LSA на каждый ASBR.

6. LSA Type 6: Group Membership LSA
Назначение: используется в Multicast OSPF (MOSPF) для описания групп рассылки.
Статус: редко применяется (MOSPF не поддерживается большинством вендоров, включая Cisco).

7. LSA Type 7: NSSA External LSA
Источник: ASBR в зоне типа Not-So-Stubby Area (NSSA).
Область распространения: только в пределах NSSA.
Содержание: аналогичен Type 5, но предназначен для NSSA (внешние маршруты).
Ключевая особенность: преобразуется в Type 5 на ABR при выходе из NSSA.

8. LSA Type 8: External Attributes LSA (OSPFv2) / Link-Local LSA (OSPFv3)
OSPFv2: передаёт атрибуты BGP (например, MED) через OSPF (редко используется).
OSPFv3: описывает локальные ссылки для IPv6.
Статус: ограниченная поддержка на оборудовании.

9. LSA Type 9: Link Scope Opaque LSA (OSPFv2) / Intra-Area Prefix LSA (OSPFv3)
OSPFv2: используется для произвольных данных в пределах ссылки (например, для расширений).
OSPFv3: передаёт префиксы IPv6 внутри зоны.
Ключевая особенность: гибкий механизм для дополнительных данных.

10. LSA Type 10: Area Scope Opaque LSA
Область распространения: внутри зоны.
Назначение: передача произвольных данных для расширений OSPF (например, для Traffic Engineering в MPLS).
Ключевая особенность: не обрабатывается маршрутизаторами, не поддерживающими расширение.

11. LSA Type 11: AS Scope Opaque LSA
Область распространения: по всей AS.
Назначение: аналогичные Type 10, но для данных, актуальных во всей автономной системе.
Ключевая особенность: используется в специализированных сценариях (например, для MPLS TE).

Важные замечания:
Типы 1–5 — основные, встречаются в большинстве сетей.
Типы 6–11 — специализированные, применяются в узких сценариях (Multicast, IPv6, расширения OSPF).
NSSA (Type 7) позволяет использовать ASBR в «почти тупиковой» зоне, преобразуя внешние маршруты в Type 7 внутри зоны и в Type 5 за её пределами.
Opaque LSA (Types 9–11) предназначены для передачи пользовательских данных и расширений протокола.




Основные типы зон (area).
Каждая зона решает свои задачи по ограничению объёма маршрутной информации и оптимизации нагрузки на маршрутизаторы.

1. Магистральная зона (Backbone Area, Area 0, 0.0.0.0)
Роль: ядро сети OSPF, связующее звено между всеми остальными зонами.
Особенности:
 - Все межзонные маршруты проходят через Area 0.
 - Должна быть непрерывной (без «разрывов»).
 - Маршрутизаторы с интерфейсом в Area 0 называются Backbone Router.
 - LSA: принимает все типы (1–5).

2. Стандартная зона (Normal/Standard Area)
Роль: зона по умолчанию; полная маршрутизация внутри и между зонами.
Особенности:
 - Принимает обновления каналов, суммарные (Type 3) и внешние (Type 5) маршруты.
 - Нет ограничений на типы LSA.
Применение: стандартные сегменты сети, когда нужна полная топологическая информация.

3. Тупиковая зона (Stub Area)
Роль: снижение нагрузки на маршрутизаторы за счёт фильтрации внешних маршрутов.
Особенности:
 - Принимает LSA Type 3 (Summary).
 - Не принимает LSA Type 4 (ASBR Summary) и Type 5 (External).
 - ABR добавляет LSA Type 3 маршрут по умолчанию (0.0.0.0/0) для трафика вне OSPF-домена.
 - Внутри зоны циркулируют только LSA Type 1, 2 и 3.
Ограничения: в Stub Area не может находиться ASBR.

4. Полностью тупиковая зона (Totally Stubby Area, TSA)
Роль: максимальное сокращение LSDB за счёт фильтрации межзонных и внешних маршрутов.
Особенности:
 - Блокирует LSA Type 3 (межзонные), Type 4 и Type 5.
 - ABR анонсирует только маршрут по умолчанию.
 - Внутри зоны — только LSA Type 1 и 2.
Примечание: термин Totally Stubby введён Cisco; в стандарте OSPF такого типа нет.

5. NSSA (Not‑So‑Stubby Area)
Роль: гибридный вариант для зон, где нужен ASBR, но без полного потока внешних маршрутов.
Особенности:
 - Разрешает ASBR внутри зоны (генерирует LSA Type 7 для внешних маршрутов).
 - ABR преобразует Type 7 в Type 5 при выходе из NSSA.
 - Не принимает внешние маршруты из других зон (Type 5).
Когда использовать: если в зоне есть маршрутизатор, импортирующий маршруты из другой АС (например, через BGP).

6. Totally NSSA
Роль: комбинация NSSA и Totally Stubby.
Особенности:
 - Блокирует LSA Type 3, 4 и 5.
 - ASBR внутри зоны использует Type 7.
 - ABR анонсирует маршрут по умолчанию.
Примечание: также специфичен для Cisco.


Как выбрать тип зоны?
 - Area 0 — обязательна для мультизонной сети.
 - Standard — если нужна полная информация о топологии.
 - Stub/TSA — для филиалов с низкопроизводительными маршрутизаторами.
 - NSSA — если в зоне есть ASBR, но не хочется перегружать LSDB внешними маршрутами.




Типичные проблемы и диагностика:
Соседство не поднимается до Full:
 - Несовпадение Area ID, аутентификации или масок.
 - Разные значения Hello/Dead Interval.
 - Блокировка пакетов OSPF (firewall, ACL).

Соседство поднимается до 2-WAY:
 - Не совпадение MTU.
 - в шаринг сенгменте, DROTHER поднимают соседство между собой только до 2-WAY.

Отсутствие DR/BDR:
 - Все приоритеты 0.
 - Некорректная настройка сети (например, point‑to‑point вместо broadcast).

Частые пересчёты SPF:
 - Нестабильность соседства (проверьте физические линки, таймеры).




Virtual-Link?
Расчет метрик?
Суммаризация:
1. Внутренних маршрутов - применимо для домена OSPF.
router ospf 1
area 10 range 10.0.1.0 255.255.255.0
2. Внешних маршрутов - применимо для инжектированных в OSPF маршрутов.
summary-address 100.0.0.0 255.255.0.0

Фильтрация?




Тупиковые зоны OSPF:

Тип области	ABR передаёт LSA type 5 в область?	ABR передаёт LSA type 3 в область?	Позволена редистрибуция в тупиковую зону?	Команда конфигурирования
Stubby	Нет	Да	Нет	area <номер> stub
Totally stubby	Нет	Нет	Нет	area <номер> stub no-summary
NSSA	Нет	Да	Да	area <номер> nssa
Totally NSSA	Нет	Нет	Да	area <номер> nssa no-summary



Loop-Free Alternate (LFA) в OSPF
Для быстрого переключения с основного маршрута на резервный в протоколе OSPF используется технология LFA (Loop-Free Alternate).
При включении данной опции создаётся новая таблица с резервными, надёжными маршрутами для быстрого переключения маршрутов (fast-reroute). Под надёжностью маршрута здесь понимается защищённость его от петель.
Если маршрутизатор детектирует падение локального линка, по которому строился основной маршрут, то в FIB моментально отправляется заранее выбранный резервный маршрут.
Пересчёт дерева по алгоритму SPF осуществляется независимо от переключения на резервный маршрут и может происходить как во время переключений, так и после.
Для того чтобы резервный маршрут был добавлен в таблицу быстрого переключения маршрутов, необходимо и достаточно выполнения следующего условия:
D(N,D) < D(N,S) + D(S,D) где: D(x,y) — расстояние между x и y, выраженное в ospf-метрике; N — соседний маршрутизатор, через который ищется резервный путь; D — маршрут назначения; S — источник.
Резервный маршрут может быть только один. Когда на роль резервного маршрута есть несколько претендентов, то работают следующие правила:
Выигрывает маршрут с наименьшей метрикой.
Если метрики равны, то выбирается маршрут с наименьшим адресом соседнего маршрутизатора.
Изменить эти правила нельзя.
Если в основной таблице маршрутизации RIB находятся два активных маршрута, т.е. работает ECMP, то таблица для маршрутов быстрого переключения будет пуста.
Резервный маршрут рассчитывается для каждого основного маршрута отдельно (per-prefix LFA). В случае для ECMP альтернативным для каждого основного маршрута будет второй активный маршрут. Поскольку эти маршруты и так находятся в основной таблице маршрутизации, то нет необходимости их помещать в таблицу для быстрого переключения маршрутов.
Для включения данной технологии используется команда fast-reroute keep-all-paths в режиме конфигурации протокола OSPF.
Для отключения технологии на конкретных интерфейсах используется команда ip ospf fast-reroute per-prefix candidate disable.
Просмотреть потенциальные резервные маршруты можно с помощью команды show ip route fast-reroute. Вывод данной команды аналогичен формату вывода команды show ip route.
Данный функционал доступен также при работе в VRF. Команда для просмотра — show ip route vrf <NAME> fast-reroute, где NAME — имя VRF.

Преимущество OSPF:
1. Каждый маршрутизатор в домене маршрутизации имеет точную информацию о топологии сети передачи
данных, следовательно, он может гарантировать, что в таблицу маршрутиза-
ции будут внесены истинные и оптимальные маршруты до сетей получателей.
Второе преимущество следует из первого. Оно заключается в том, что
если маршрутизатор имеет точную информацию о топологии сети передачи
данных в домене маршрутизации, он может самостоятельно, не прибегая к
механизму рассылки запросов соседним маршрутизаторам, о возможных аль-
тернативных маршрутах, вносить изменения в таблицу маршрутизации, после
того как, он обнаружил недоступность того или иного маршрута.

Оптимизации:
3. Фильтрация и суммаризация маршрутов
Суммаризация маршрутов значительно уменьшает размер таблицы маршрутизации и LSDB:
# Суммаризация на ABR (Cisco)
Router(config-router)# area 1 range 192.168.0.0 255.255.0.0
# Суммаризация на ASBR (Cisco)
Router(config-router)# summary-address 10.0.0.0 255.0.0.0

4. Настройка приоритетов для выбора DR/BDR
В сетях с множественным доступом OSPF выбирает выделенный (DR) и резервный выделенный (BDR) маршрутизаторы для снижения количества соседских отношений:
# Установка приоритета OSPF (Cisco)
Router(config-if)# ip ospf priority 100
Маршрутизаторы с более высокими значениями приоритета имеют больше шансов стать DR. Значение 0 исключает маршрутизатор из процесса выбора.

5. Оптимизация LSA
Ограничение генерации и обработки LSA снижает нагрузку на маршрутизаторы:
# Настройка задержки генерации LSA (Cisco)
Router(config-router)# timers throttle lsa all 50 200 5000
# Настройка LSA групп (Cisco)
Router(config-router)# timers pacing lsa-group 60

6. Использование BFD для быстрого обнаружения отказов
Bidirectional Forwarding Detection (BFD) позволяет OSPF быстрее обнаруживать отказы каналов:
# Включение BFD на Cisco
Router(config)# bfd interval 100 min_rx 100 multiplier 3
Router(config-if)# ip ospf bfd

7. Настройка ECMP (Equal-Cost Multi-Path)
OSPF поддерживает распределение нагрузки по равноценным маршрутам:
# Настройка количества путей для ECMP (Cisco)
Router(config-router)# maximum-paths 8

